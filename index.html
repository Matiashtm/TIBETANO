<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dos Osciladores con Cutoff y ADSR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>

  <style>
    body {
      background: #000;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 15px;
      user-select: none;
    }
    .contenedorPrincipal {
      width: 95%;
      max-width: 1200px;
      background: #111;
      border: 6px solid #444;
      border-radius: 14px;
      padding: 20px 10px;
      display: flex;
      justify-content: center;
      gap: 15px;
      box-shadow: 0 0 15px #222 inset;
      flex-direction: row;
    }
    .SliderContainer {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      background-color: #121212dd;
      padding: 12px 8px;
      border-radius: 10px;
      width: 80px;
      box-shadow: 0 0 10px #222 inset;
      transition: box-shadow 0.3s ease;
    }
    .SliderContainer:hover {
      box-shadow: 0 0 25px #00ffffcc inset;
    }
    input[type="range"] {
      margin-top: 80px;
      -webkit-appearance: none;
      appearance: none;
      width: 150px;
      height: 12px;
      background: linear-gradient(90deg, #0ff, #008080);
      border-radius: 6px;
      cursor: pointer;
      transform: rotate(-90deg);
      outline: none;
      box-shadow: 0 0 8px #00ffff88;
      transition: background 0.3s ease;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 36px;
      background: #00ffff;
      border-radius: 6px;
      border: 2px solid #004444;
      box-shadow: 0 0 12px #00ffffbb;
      cursor: pointer;
      transition: background 0.3s ease, box-shadow 0.3s ease;
      margin-top: -12px;
    }
    input[type="range"]:hover::-webkit-slider-thumb {
      background: #00ffffee;
      box-shadow: 0 0 20px #00ffffee;
    }
    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 36px;
      background: #00ffff;
      border-radius: 6px;
      border: 2px solid #004444;
      box-shadow: 0 0 12px #00ffffbb;
      cursor: pointer;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    input[type="range"]:hover::-moz-range-thumb {
      background: #00ffffee;
      box-shadow: 0 0 20px #00ffffee;
    }
    label {
      color: #00ffffcc;
      font-size: 0.85rem;
      font-weight: 600;
      text-shadow: 0 0 5px #00ffff44;
      user-select: none;
    }
    #configNumberDisplay {
      font-size: 2rem;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      background: #0ff;
      border: none;
      border-radius: 6px;
      color: #111;
      cursor: pointer;
    }
    button:hover {
      background: #0cc;
    }
    #log {
      margin-top: 20px;
      max-width: 400px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="contenedorPrincipal">
    <div id="configNumberDisplay">Configuración actual: 1</div>
    <button id="loadConfigBtn">Cargar Configuración</button>

    <div id="log"></div>

    <div class="SliderContainer" id="BackVu">  
      <div style="display: flex; gap: 20px;">
        <canvas id="vumeter1" width="50" height="300" style="margin-top: -120px;"></canvas>
      </div>
    </div>

    <div class="SliderContainer" id="generalGainContainer">
      <input id="generalGainSlider" type="range" min="0" max="100" value="50" step="1" />
      <label for="generalGainSlider">General Gain</label>
    </div>

    <div class="SliderContainer" id="filtroContainer">
      <input id="filtroSlider" type="range" min="0" max="5000" value="1000" step="10" />
      <label for="filtroSlider">Filtro (Hz)</label>
    </div>

    <div class="SliderContainer" id="attackContainer">
      <input id="attackSlider" type="range" min="0" max="100" value="10" step="1" />
      <label for="attackSlider">Attack</label>
    </div>

    <div class="SliderContainer" id="decayContainer">
      <input id="decaySlider" type="range" min="0" max="100" value="1" step="1" />
      <label for="decaySlider">Decay</label>
    </div>

    <div class="SliderContainer" id="sustainContainer">
      <input id="sustainSlider" type="range" min="0" max="100" value="1" step="1" />
      <label for="sustainSlider">Sustain</label>
    </div>

    <div class="SliderContainer" id="releaseContainer">
      <input id="releaseSlider" type="range" min="0" max="100" value="1" step="1" />
      <label for="releaseSlider">Release</label>
    </div>

    <div class="SliderContainer" id="BackVu2">  
      <div style="display: flex; gap: 20px;">
        <canvas id="vumeter2" width="50" height="300" style="margin-top: -120px;"></canvas>
      </div>
    </div>
  </div>

<script>
  // Variables globales para configuración y control de sliders
  let TIPO_ONDA1 = "square";
  let TIPO_ONDA2 = "sine";
  let TIPO_ONDA3 = "sine";
  let TIPO_FILTRO = "lowpass";

  let delayTimeMs = 0;
  let delayTime2Ms = 0;
  let delayTime3Ms = 0;

  let TIPO_LFO1 = "sine";
  let TIPO_LFO2 = "sine";
  let TIPO_LFO3 = "sine";

  // Ganancias y detunes (puedes exponerlos a UI si quieres)
  let gain1Slider = 70;
  let gain2Slider = 50;
  let gain3Slider = 40;

  let detuneSlider = 0;
  let detune3Slider = 0;

  let filterQSlider = 1;

  let leslieSlider = 0;
  let leslieGainSlider = 0;

  let tremoloSlider = 0;
  let tremoloGainValue = 0;

  // Elementos DOM sliders
  const generalGainSlider = document.getElementById("generalGainSlider");
  const filtroSlider = document.getElementById("filtroSlider");
  const attackSlider = document.getElementById("attackSlider");
  const decaySlider = document.getElementById("decaySlider");
  const sustainSlider = document.getElementById("sustainSlider");
  const releaseSlider = document.getElementById("releaseSlider");

  // Variables para audio
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const mediaDest = audioCtx.createMediaStreamDestination();

  // Analyser para vumeter
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = 256;

  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);

  const canvas1 = document.getElementById('vumeter1');
  const canvas2 = document.getElementById('vumeter2');
  const ctx1 = canvas1.getContext('2d');
  const ctx2 = canvas2.getContext('2d');

  // Función para dibujar vumeter
  function drawVUMeter(ctx, value) {
    ctx.clearRect(0, 0, 100, 300);
    const totalBlocks = 10;
    const blockHeight = 12;
    const gap = 3;

    const maxValue = 0.3;
    const scaledValue = Math.min(value / maxValue, 1);
    const curvedValue = Math.pow(scaledValue, 0.5);

    const filledBlocks = Math.round(curvedValue * totalBlocks);

    for (let i = 0; i < totalBlocks; i++) {
      const y = 300 - (i + 1) * (blockHeight + gap);
      if (i < filledBlocks) {
        if (i < totalBlocks * 0.3) {
          ctx.fillStyle = 'lime';
        } else if (i < totalBlocks * 0.5) {
          ctx.fillStyle = 'yellow';
        } else {
          ctx.fillStyle = 'red';
        }
      } else {
        ctx.fillStyle = '#222';
      }
      ctx.fillRect(10, y, 30, blockHeight);
    }
  }

  function animateVUMeters() {
    requestAnimationFrame(animateVUMeters);
    analyser.getByteFrequencyData(dataArray);

    let sum = 0;
    for (let i = 0; i < bufferLength; i++) {
      sum += dataArray[i];
    }
    const average = sum / bufferLength / 256;

    drawVUMeter(ctx1, average);
    drawVUMeter(ctx2, average);
  }

  animateVUMeters();

  // Variables para control de nota y pitch bend
  let freqBase = 440;
  let pitchBendSemitones = 0;
  let currentNote = null;

  // Mapa de frecuencias por tecla
  const keyFreqMap = {
    a: 261.63, q: 277.18, s: 293.66, w: 311.13, d: 329.63, f: 349.23, e: 369.99,
    g: 392.00, r: 415.30, h: 440.00, t: 466.16, j: 493.88, k: 523.25, y: 554.37,
    l: 587.33, u: 622.25, 'ñ': 659.25, '{': 698.46, i: 739.99, '}': 783.99,
    o: 830.61, z: 880.00, p: 932.33, x: 987.77
  };

  const activeNotes = new Map();

  // startNote: crea y dispara un sonido con 3 osciladores, filtro, ADSR y LFOs
  function startNote(freq) {
    const now = audioCtx.currentTime;

    // Validar pitch bend seguro
    if (typeof pitchBendSemitones !== 'number' || !isFinite(pitchBendSemitones)) {
      pitchBendSemitones = 0;
    }

    const freqBend = freq * Math.pow(2, pitchBendSemitones / 12);
    if (!isFinite(freqBend)) return;

    // Crear nodos
    const gain1 = audioCtx.createGain();
    const gain2 = audioCtx.createGain();
    const gain3 = audioCtx.createGain();
    const filter = audioCtx.createBiquadFilter();
    const finalGain = audioCtx.createGain();

    // OSC1
    let osc1 = audioCtx.createOscillator();
    osc1.type = TIPO_ONDA1;
    osc1.frequency.setValueAtTime(freqBend, now);
    osc1.connect(gain1);
    osc1.start(now);

    // OSC2
    let osc2 = audioCtx.createOscillator();
    osc2.type = TIPO_ONDA2;
    osc2.frequency.setValueAtTime(freqBend, now);
    osc2.detune.setValueAtTime(detuneSlider, now);
    osc2.connect(gain2);
    osc2.start(now);

    // OSC3
    let osc3 = audioCtx.createOscillator();
    osc3.type = TIPO_ONDA3;
    osc3.frequency.setValueAtTime(freqBend, now);
    osc3.detune.setValueAtTime(detune3Slider, now);
    osc3.connect(gain3);
    osc3.start(now);

    // Ganancias individuales
    gain1.gain.setValueAtTime(gain1Slider / 100, now);
    gain2.gain.setValueAtTime(gain2Slider / 100, now);
    gain3.gain.setValueAtTime(gain3Slider / 100, now);

    // Filtro
    filter.type = TIPO_FILTRO;
    filter.frequency.setValueAtTime(parseFloat(filtroSlider.value), now);
    filter.Q.setValueAtTime(filterQSlider, now);

    // Conectar ganancia de osciladores al filtro
    gain1.connect(filter);
    gain2.connect(filter);
    gain3.connect(filter);

    // ADSR en ganancia final
    const generalGain = parseFloat(generalGainSlider.value) / 100;
    const attack = parseFloat(attackSlider.value) / 100;
    const decay = parseFloat(decaySlider.value) / 100;
    const sustain = parseFloat(sustainSlider.value) / 100;
    const release = parseFloat(releaseSlider.value) / 100;

    finalGain.gain.setValueAtTime(0, now);
    finalGain.gain.linearRampToValueAtTime(generalGain, now + attack);
    finalGain.gain.linearRampToValueAtTime(generalGain * sustain, now + attack + decay);

    // LFOs - detune (vibrato)
    const lfoDetune = audioCtx.createOscillator();
    const lfoDetuneGain = audioCtx.createGain();
    lfoDetune.frequency.value = leslieSlider;
    lfoDetuneGain.gain.value = leslieGainSlider;
    lfoDetune.type = TIPO_LFO1;
    lfoDetune.connect(lfoDetuneGain);
    lfoDetuneGain.connect(osc1.detune);
    lfoDetuneGain.connect(osc2.detune);
    lfoDetuneGain.connect(osc3.detune);
    lfoDetune.start(now);

    // LFO tremolo (modulación de volumen)
    const lfoTremolo = audioCtx.createOscillator();
    const lfoTremGain = audioCtx.createGain();
    lfoTremolo.frequency.value = tremoloSlider;
    lfoTremGain.gain.value = tremoloGainValue * generalGain;
    lfoTremolo.type = TIPO_LFO2;
    lfoTremolo.connect(lfoTremGain);
    lfoTremGain.connect(finalGain.gain);
    lfoTremolo.start(now);

    // LFO filtro (modulación cutoff)
    const lfoFilter = audioCtx.createOscillator();
    const lfoFilterGain = audioCtx.createGain();
    lfoFilter.frequency.value = LFOFilterValue;
    lfoFilterGain.gain.value = LFOFilterGainValue;
    lfoFilter.type = TIPO_LFO3;
    lfoFilter.connect(lfoFilterGain);
    lfoFilterGain.connect(filter.frequency);
    lfoFilter.start(now);

    // Conectar filtro a ganancia final y salida
    filter.connect(finalGain);
    finalGain.connect(analyser);
    analyser.connect(audioCtx.destination);

    // Guardar referencia para parar nota
    activeNotes.set(freq, {
      osc1, osc2, osc3,
      gain1, gain2, gain3,
      filter, finalGain,
      lfoDetune, lfoDetuneGain,
      lfoTremolo, lfoTremGain,
      lfoFilter, lfoFilterGain
    });
  }

  // stopNote con ADSR release
  function stopNote(freq) {
    const note = activeNotes.get(freq);
    if (!note) return;
    const now = audioCtx.currentTime;

    // ADSR release
    const release = parseFloat(releaseSlider.value) / 100;
    note.finalGain.gain.cancelScheduledValues(now);
    note.finalGain.gain.setValueAtTime(note.finalGain.gain.value, now);
    note.finalGain.gain.linearRampToValueAtTime(0, now + release);

    // Detener osciladores luego del release
    const stopTime = now + release + 0.05;
    [note.osc1, note.osc2, note.osc3, note.lfoDetune, note.lfoTremolo, note.lfoFilter].forEach(osc => {
      if (osc && osc.stop) {
        try {
          osc.stop(stopTime);
        } catch {}
      }
    });

    // Limpiar referencias
    setTimeout(() => {
      activeNotes.delete(freq);
    }, (release + 0.1) * 1000);
  }

  // Eventos de teclado para disparar notas
  window.addEventListener('keydown', e => {
    if (e.repeat) return;
    const key = e.key.toLowerCase();
    if (keyFreqMap[key] && !activeNotes.has(keyFreqMap[key])) {
      startNote(keyFreqMap[key]);
      log(`Nota ON: ${key} (${keyFreqMap[key]} Hz)`);
    }
  });

  window.addEventListener('keyup', e => {
    const key = e.key.toLowerCase();
    if (keyFreqMap[key] && activeNotes.has(keyFreqMap[key])) {
      stopNote(keyFreqMap[key]);
      log(`Nota OFF: ${key} (${keyFreqMap[key]} Hz)`);
    }
  });

  // Log simple para mostrar acciones
  const logDiv = document.getElementById('log');
  function log(msg) {
    logDiv.textContent = msg + '\n' + logDiv.textContent;
  }

  // Actualizar valores sliders a variables (puedes agregar más listeners para otros sliders si quieres)
  generalGainSlider.addEventListener('input', () => {
    // Nada extra por ahora
  });
  filtroSlider.addEventListener('input', () => {
    // Nada extra por ahora
  });
  attackSlider.addEventListener('input', () => {});
  decaySlider.addEventListener('input', () => {});
  sustainSlider.addEventListener('input', () => {});
  releaseSlider.addEventListener('input', () => {});

  // Botón para cargar una configuración de ejemplo
  const loadConfigBtn = document.getElementById('loadConfigBtn');
  loadConfigBtn.addEventListener('click', () => {
    // Ejemplo de configuración:
    TIPO_ONDA1 = "square";
    TIPO_ONDA2 = "triangle";
    TIPO_ONDA3 = "sine";
    TIPO_FILTRO = "lowpass";

    gain1Slider = 80;
    gain2Slider = 40;
    gain3Slider = 30;

    detuneSlider = 10;
    detune3Slider = -10;

    filterQSlider = 5;

    leslieSlider = 5;  // LFO detune freq
    leslieGainSlider = 10; // LFO detune gain

    tremoloSlider = 7;
    tremoloGainValue = 0.5;

    LFOFilterValue = 1.5;
    LFOFilterGainValue = 1000;

    generalGainSlider.value = 60;
    filtroSlider.value = 1500;
    attackSlider.value = 20;
    decaySlider.value = 15;
    sustainSlider.value = 50;
    releaseSlider.value = 25;

    document.getElementById('configNumberDisplay').textContent = "Configuración actual: 1";

    log("Configuración cargada");
  });
</script>
</body>
</html>
